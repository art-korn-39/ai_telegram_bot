package main

import (
	"database/sql"
	"encoding/json"
	"fmt"
	"io"
	"log"
	"os"
	"slices"
	"time"

	tgbotapi "github.com/Syfaro/telegram-bot-api"
	_ "github.com/lib/pq"
)

const (
	Version       = "1.3"
	ChannelChatID = -1001997602646
	ChannelURL    = "https://t.me/+6ZMACWRgFdRkNGEy"
)

var (
	db              *sql.DB
	Bot             *tgbotapi.BotAPI
	Cfg             config
	Logs            chan Log
	ListOfUsers     = map[int64]*UserInfo{}
	arrayCMD        = []string{"gemini", "kandinsky", "chatgpt"}
	delay_ChatGPT   = time.Tick(time.Second * 12 / 11) // 55 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
	delay_Gemini    = time.Tick(time.Second * 12 / 11) // 55 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
	delay_Kandinsky = time.Tick(time.Second / 3)       // 20 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
)

//sql
//ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
//Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑÑ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°

//Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð·Ð°Ð¿Ð¸ÑÐµÐ¹:
// data_time | user id | username | chatgpt | gemini | kandinskiy | request

//Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ ChatGPT Ð² Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ â€“ 60 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
//Gemini Ð² Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾Ð¼ Ñ‚Ð°Ñ€Ð¸Ñ„Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð½Ð° 60 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ.

//ID chat (art_korn_39) = 403059287
//ID chat (art_korneev) = 609614322
//ID chat (apolo39) = 6648171361

func main() {

	defer LogPanic("", true)

	// Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
	LoadConfig()

	// Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°
	StartBot()

	// Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ñ Ð±Ð°Ð·Ð¾Ð¹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
	SQL_Connect()

	// u - ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¾Ð¼ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð°Ð¿Ð´ÐµÐ¹Ñ‚Ð¾Ð²
	u := tgbotapi.NewUpdate(0)
	u.Timeout = 60

	// Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ ÐºÐ¾Ð½Ñ„Ð¸Ð³ u ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ°Ð½Ð°Ð» Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ñ€Ð¸Ð»ÐµÑ‚Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
	updates, _ := Bot.GetUpdatesChan(u)

	// Ð’ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾ Ð³Ð¾Ñ€ÑƒÑ‚Ð¸Ð½Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¿Ð¾ Ð»Ð¾Ð³Ð°Ð¼
	Logs = make(chan Log, 10)
	go SaveLogs()

	// Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¸Ð· ÐºÐ°Ð½Ð°Ð»Ð°
	for update := range updates {

		go func(upd tgbotapi.Update) {

			// Ð—Ð°Ð¿Ð¸ÑˆÐµÐ¼ panic ÐµÑÐ»Ð¸ Ð³Ð¾Ñ€ÑƒÑ‚Ð¸Ð½Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»Ð°ÑÑŒ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹
			defer LogPanic(upd.Message.Text, false)

			if upd.Message == nil {
				return
			}

			// Ð•ÑÐ»Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð±Ñ‹Ð»Ð¾ Ð±Ð¾Ð»ÑŒÑˆÐµ 10 Ð¼Ð¸Ð½ÑƒÑ‚ Ð½Ð°Ð·Ð°Ð´, Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼
			if time.Since(upd.Message.Time()).Seconds() > 600 {
				Logs <- Log{upd.Message.From.UserName, "(timeout) " + upd.Message.Text, false}
				return
			}

			// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ð° ÐºÐ°Ð½Ð°Ð»
			if !AccessIsAllowed(upd) {
				return
			}

			// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
			User, ok := ListOfUsers[upd.Message.Chat.ID]
			if !ok {
				User = &UserInfo{}
				ListOfUsers[upd.Message.Chat.ID] = User
			}

			// Ð¤Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ Ð²Ñ…Ð¾Ð´ÑÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
			Logs <- Log{upd.Message.From.UserName, upd.Message.Text, false}

			// Ð•ÑÐ»Ð¸ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ ÐµÑ‰Ñ‘ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ, Ñ‚Ð¾ Ð½Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð½Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼
			if User.CheckUserLock(upd) {
				return
			}
			defer User.SetIsRunning(false)

			// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
			var result ResultOfRequest
			if MsgIsCommand(upd.Message) {
				cmd := MsgCommand(upd.Message)
				User.LastCommand = cmd
				result = ProcessCommand(cmd, upd)
			} else {
				result = ProcessText(upd.Message.Text, User.LastCommand, upd)
			}

			// ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
			Bot.Send(result.Message)

			// ÐžÐ±Ñ‰Ð¸Ð¹ Ð»Ð¾Ð³, Ð¿Ð¸ÑˆÐµÐ¼ ÑÑŽÐ´Ð° Ð²ÑÐµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
			Logs <- Log{result.Log_author, result.Log_message, false}

		}(update)
	}
}

func LoadConfig() {

	log.Println("Version: " + Version)

	file, err := os.OpenFile("config.txt", os.O_RDONLY, 0600)
	if err != nil {
		panic(err)
	}
	defer file.Close()

	b, err := io.ReadAll(file)
	if err != nil {
		panic(err)
	}

	json.Unmarshal(b, &Cfg)

	log.Println("Config download complete")

}

func StartBot() {

	// Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ Ñ‚Ð¾ÐºÐµÐ½ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¸Ð½ÑÑ‚Ð°Ð½Ñ Ð±Ð¾Ñ‚Ð°
	var err error
	Bot, err = tgbotapi.NewBotAPI(Cfg.TelegramBotToken)
	if err != nil {
		log.Panic(err)
	}

	log.Printf("Authorized on account %s", Bot.Self.UserName)

}

func SQL_Connect() {

	return

	// Capture connection properties.
	psqlInfo := fmt.Sprintf("host=%s port=%d user=%s "+
		"password=%s dbname=%s sslmode=disable",
		Cfg.DB_host, Cfg.DB_port, Cfg.DB_user, Cfg.DB_password, Cfg.DB_name)

	// Get a database handle.
	var err error
	db, err = sql.Open("postgres", psqlInfo)

	if err != nil {
		log.Println("Unsuccessful connection to PostgreSQL!")
		log.Fatal(err)
	}

	pingErr := db.Ping()
	if pingErr != nil {
		log.Println("Unsuccessful connection to PostgreSQL!")
		log.Fatal(pingErr)
	}

	log.Println("Successful connection to PostgreSQL")

}

func AccessIsAllowed(upd tgbotapi.Update) bool {

	if !Cfg.CheckSubscription {
		return true
	}

	if slices.Contains(Cfg.WhiteList, upd.Message.Chat.UserName) {
		return true
	}

	result := true

	conf := tgbotapi.ChatConfigWithUser{ChatID: ChannelChatID, UserID: int(upd.Message.Chat.ID)}
	chatMember, err := Bot.GetChatMember(conf)
	if err != nil {
		Logs <- Log{"bot{GetChatMember}", err.Error(), true}
		msg := tgbotapi.NewMessage(upd.Message.Chat.ID, "ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð½ÐµÐ¿Ñ€ÐµÐ´Ð²Ð¸Ð´ÐµÐ½Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.")
		Bot.Send(msg)
		result = false
	}

	if !(chatMember.IsCreator() ||
		chatMember.IsAdministrator() ||
		chatMember.IsMember()) && upd.Message.Text != "/start" {

		msg := tgbotapi.NewMessage(upd.Message.Chat.ID, "Ð”Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð±Ð¾Ñ‚Ð° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° ÐºÐ°Ð½Ð°Ð»ðŸ‘‡")
		var button = tgbotapi.NewInlineKeyboardMarkup(
			tgbotapi.NewInlineKeyboardRow(
				tgbotapi.NewInlineKeyboardButtonURL("âœ…ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ", ChannelURL),
			),
		)
		msg.ReplyMarkup = button
		Bot.Send(msg)
		result = false
	}

	return result

}

// Ð ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· webhook
// if _, err := bot.SetWebhook(tgbotapi.NewWebhook(WebHook)); err != nil {
// 	log.Fatalf("setting webhook %v; error: %v", WebHook, err)
// }

//bot.ListenForWebhook("/")
